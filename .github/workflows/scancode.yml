name: ScanCode License Scan
on: [workflow_dispatch]

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Input Directory
        run: |
          mkdir -p scancode-inputs
          rsync -a --exclude='.git/' --exclude='.github/' ./ scancode-inputs/ || cp -r ./* ./scancode-inputs/ 2>/dev/null || true

      - name: Run ScanCode Analysis
        uses: nexb/scancode-action@main
        with:
          pipelines: scan_codebase
          # 核心：直接使用工具默认的JSON输出
          output-formats: json
          # 确保生成一个固定名称的报告，便于后续查找
          outputs-archive-name: license-scan-results
          project-name: FileServerClient

      - name: Find and Upload Generated Report
        # 此步骤在工具运行后，寻找它生成的报告文件
        run: |
          echo "正在查找生成的报告..."
          # 搜索项目目录下新生成的 .json 文件
          find . -name "*.json" -newer /proc/self -type f 2>/dev/null | head -5
          echo "报告应已包含在上传的Artifact中。"

      # 注意：报告已由 `scancode-action` 自动打包并上传，
      # 其Artifact名称由上面的 `outputs-archive-name` 决定（如 `license-scan-results-*.zip`）。